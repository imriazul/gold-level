//@version=5
strategy("Gold label strategy by @imriazul (Backtest)", overlay=true, pyramiding=0, commission_type=strategy.commission.percent, commission_value=0)

//==================== SETTINGS ====================
useDST = input.bool(true, "DST", tooltip="Daylight Saving Time ON/OFF")

tpMode = input.string("Base TP (Mid)", "Take Profit Mode",
     options=["Base TP (Mid)", "Full TP (Top/Bottom)"],
     tooltip="Base uses extUpMid/extDownMid. Full uses extUpTop/extDownBot.")

//==================== FORCED EXIT (Extension modes) ====================
useForcedExit = input.bool(true, "Forced Exit (Extension TP)")
forceExitHour = input.int(20, "Force Exit Hour (Dhaka)", minval=0, maxval=23)
forceExitMin  = input.int(0,  "Force Exit Minute (Dhaka)", minval=0, maxval=59)

//==================== TIME & SYMBOL CHECKS ====================
dhakaHour   = hour(time, "Asia/Dhaka")
dhakaMinute = minute(time, "Asia/Dhaka")

targetHour   = useDST ? 6 : 7
isTargetTime = (dhakaHour == targetHour and dhakaMinute == 0)

// Entry window: 2 hours from anchor time (inclusive)
dhakaMins    = dhakaHour * 60 + dhakaMinute
entryStart   = targetHour * 60
entryEnd     = entryStart + 120
inEntryTime  = (dhakaMins >= entryStart) and (dhakaMins <= entryEnd)

isGoldChart = syminfo.ticker == "XAUUSD" or syminfo.ticker == "GOLD" or str.contains(syminfo.ticker, "XAU")
is5m        = (timeframe.period == "5")

//==================== EMAs ====================
ema9  = ta.ema(close, 9)
ema15 = ta.ema(close, 15)
plot(ema9,  title="EMA 9",  color=color.orange, linewidth=1)
plot(ema15, title="EMA 15", color=color.blue,   linewidth=1)

//==================== RANGE + LEVEL VARS ====================
var float openingValue = na
var float rangUp       = na
var float rangDown     = na
var float level37_5    = na
var float level62_5    = na

var float extUpTop     = na
var float extUpMid     = na
var float extDownMid   = na
var float extDownBot   = na

// One-trade-per-day control (Dhaka day)
var bool tradedToday = false
newDhakaDay = ta.change(time("D", "Asia/Dhaka"))

// Forced-exit once-per-day guard
var bool forcedExitDone = false

if newDhakaDay
    tradedToday     := false
    forcedExitDone  := false

//==================== BUILD RANGE ON TARGET CANDLE ====================
if isGoldChart and is5m and isTargetTime
    openingValue := open

    sqrtVal  = math.sqrt(openingValue)
    forUp    = sqrtVal + 0.105
    forDown  = sqrtVal - 0.105
    rangUp   := forUp * forUp
    rangDown := forDown * forDown

    rangeDiff = rangUp - rangDown
    level37_5 := rangDown + rangeDiff * 0.375
    level62_5 := rangDown + rangeDiff * 0.625

    // Inner box height and extended targets
    innerH = level62_5 - level37_5
    extH   = innerH * 2.0

    // Extended UP: rangUp -> extUpTop
    extUpTop := rangUp + extH
    extUpMid := rangUp + (extH / 2.0)

    // Extended DOWN: extDownBot -> rangDown
    extDownBot := rangDown - extH
    extDownMid := rangDown - (extH / 2.0)

//==================== PICK TP BASED ON USER MODE ====================
levelsReady = not na(level37_5) and not na(level62_5) and not na(extUpMid) and not na(extDownMid) and not na(extUpTop) and not na(extDownBot)

buyTP  = tpMode == "Full TP (Top/Bottom)" ? extUpTop    : extUpMid
sellTP = tpMode == "Full TP (Top/Bottom)" ? extDownBot : extDownMid

//==================== FORCED EXIT TIME (Extension TP) ====================
isForceExitTime = (dhakaHour == forceExitHour and dhakaMinute == forceExitMin)

// (In this script, both TP modes are extension-based. This flag is kept for consistency.)
isExtensionMode = true

if useForcedExit and isExtensionMode and isGoldChart and is5m and isForceExitTime and not forcedExitDone
    forcedExitDone := true

    // Close any open position at the selected time
    if strategy.position_size != 0
        strategy.close_all(comment="FORCED EXIT TIME")

    // Optional safety: cancel any resting orders (none in this script, but harmless)
    strategy.cancel("BUY")
    strategy.cancel("SELL")
    strategy.cancel("BUY-EXIT")
    strategy.cancel("SELL-EXIT")

//==================== ENTRY CONDITIONS ====================
buyCond  = isGoldChart and is5m and inEntryTime and levelsReady and not tradedToday and strategy.position_size == 0 and close > level62_5
sellCond = isGoldChart and is5m and inEntryTime and levelsReady and not tradedToday and strategy.position_size == 0 and close < level37_5

//==================== ORDERS ====================
if buyCond
    strategy.entry("BUY", strategy.long)
    strategy.exit("BUY-EXIT", "BUY", stop=level37_5, limit=buyTP)
    tradedToday := true

if sellCond
    strategy.entry("SELL", strategy.short)
    strategy.exit("SELL-EXIT", "SELL", stop=level62_5, limit=sellTP)
    tradedToday := true

//==================== OPTIONAL: PLOT LEVELS ====================
plot(level37_5, "Level 37.5%", color=color.new(color.red, 0), linewidth=1, style=plot.style_linebr)
plot(level62_5, "Level 62.5%", color=color.new(color.green, 0), linewidth=1, style=plot.style_linebr)

plot(extUpMid,   "Ext Up Mid (Base TP)",   color=color.new(color.fuchsia, 0), linewidth=1, style=plot.style_linebr)
plot(extUpTop,   "Ext Up Top (Full TP)",   color=color.new(color.purple,  0), linewidth=1, style=plot.style_linebr)

plot(extDownMid, "Ext Down Mid (Base TP)", color=color.new(color.aqua,    0), linewidth=1, style=plot.style_linebr)
plot(extDownBot, "Ext Down Bot (Full TP)", color=color.new(color.teal,    0), linewidth=1, style=plot.style_linebr)