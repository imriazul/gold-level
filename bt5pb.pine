//@version=5
strategy("Gold label strategy by @imriazul (5m Pullback LIMIT â€¢ HARD 1 trade/day)", overlay=true, pyramiding=0, calc_on_every_tick=true)

//==================== SETTINGS ====================
useDST  = input.bool(true, "DST")

tpMode = input.string(defval="Base TP (Mid)", title="Take Profit Mode",
     options=["Base TP (Mid)", "Range TP (rangUp/rangDown)", "Full TP (Top/Bottom)"],
     tooltip="Base: extUpMid/extDownMid. Range: rangUp/rangDown. Full: extUpTop/extDownBot.")

slMode = input.string(defval="Regular SL", title="Stop Loss Mode",
     options=["Regular SL", "Tied SL (6:00/7:00 open)"],
     tooltip="Regular SL: opposite inner level (buy->37.5%, sell->62.5%). Tied SL: anchor 5m candle open price.")

//==================== FORCED EXIT (Extension modes only) ====================
useForcedExit = input.bool(true, "Forced Exit (Extension TP only)")
forceExitHour = input.int(20, "Force Exit Hour (Dhaka)", minval=0, maxval=23)
forceExitMin  = input.int(0,  "Force Exit Minute (Dhaka)", minval=0, maxval=59)

//==================== TIME ====================
dhakaHour   = hour(time, "Asia/Dhaka")
dhakaMinute = minute(time, "Asia/Dhaka")

targetHour   = useDST ? 6 : 7
isTargetTime = (dhakaHour == targetHour and dhakaMinute == 0)

// Entry window (2 hours from anchor time)
dhakaMins    = dhakaHour * 60 + dhakaMinute
entryStart   = targetHour * 60
entryEnd     = entryStart + 120
inEntryTime  = (dhakaMins >= entryStart) and (dhakaMins <= entryEnd)

is5m   = timeframe.period == "5"
isGold = syminfo.ticker == "XAUUSD" or syminfo.ticker == "GOLD" or str.contains(syminfo.ticker, "XAU")

//==================== RANGE ====================
var float rangUp      = na
var float rangDown    = na
var float level37_5   = na
var float level62_5   = na
var float extUpTop    = na
var float extUpMid    = na
var float extDownBot  = na
var float extDownMid  = na

var float anchorOpen  = na 

if isGold and is5m and isTargetTime
    anchorOpen := open

    sqrtVal   = math.sqrt(open)
    rangUp    := math.pow(sqrtVal + 0.105, 2)
    rangDown  := math.pow(sqrtVal - 0.105, 2)

    diff      = rangUp - rangDown
    level37_5 := rangDown + diff * 0.375
    level62_5 := rangDown + diff * 0.625

    innerH    = level62_5 - level37_5
    extH      = innerH * 2.0

    extUpTop    := rangUp + extH
    extUpMid    := rangUp + (extH / 2.0)
    extDownBot  := rangDown - extH
    extDownMid  := rangDown - (extH / 2.0)

levelsReady = not na(level37_5) and not na(level62_5) and not na(extUpMid) and not na(extDownMid) and not na(extUpTop) and not na(extDownBot) and not na(rangUp) and not na(rangDown) and not na(anchorOpen)

//==================== TP selection ====================
buyTP  = tpMode == "Full TP (Top/Bottom)" ? extUpTop :
         tpMode == "Range TP (rangUp/rangDown)" ? rangUp :
         extUpMid

sellTP = tpMode == "Full TP (Top/Bottom)" ? extDownBot :
         tpMode == "Range TP (rangUp/rangDown)" ? rangDown :
         extDownMid

//==================== SL selection ====================
// Regular: buy SL = level37_5, sell SL = level62_5
// Tied: both sides SL = anchorOpen (6:00/7:00 5m candle open)
buySL  = slMode == "Tied SL (6:00/7:00 open)" ? anchorOpen : level37_5
sellSL = slMode == "Tied SL (6:00/7:00 open)" ? anchorOpen : level62_5

//==================== HARD 1 TRADE PER DAY (Dhaka) ====================
var bool dayLocked    = false
var bool tradeDone    = false
var bool waitingBuy   = false
var bool waitingSell  = false
var bool orderPlaced  = false

opentrades_chg   = ta.change(strategy.opentrades)
closedtrades_chg = ta.change(strategy.closedtrades)

//==================== FORCED EXIT TIME (Extension TP only) ====================
var bool forcedExitDone = false
isExtensionMode = (tpMode != "Range TP (rangUp/rangDown)")
isForceExitTime = (dhakaHour == forceExitHour and dhakaMinute == forceExitMin)

// New Dhaka day reset
if ta.change(time("D", "Asia/Dhaka"))
    dayLocked       := false
    tradeDone       := false
    waitingBuy      := false
    waitingSell     := false
    orderPlaced     := false
    forcedExitDone  := false
    strategy.cancel("BUY-LIMIT")
    strategy.cancel("SELL-LIMIT")

// Also reset at new range anchor candle (safe)
if isGold and is5m and isTargetTime
    dayLocked       := false
    tradeDone       := false
    waitingBuy      := false
    waitingSell     := false
    orderPlaced     := false
    forcedExitDone  := false
    strategy.cancel("BUY-LIMIT")
    strategy.cancel("SELL-LIMIT")

// Force close open trade + cancel orders once per day at selected time (Extension TP only)
if useForcedExit and isExtensionMode and isGold and is5m and isForceExitTime and not forcedExitDone
    forcedExitDone := true

    // Close any open position immediately
    if strategy.position_size != 0
        strategy.close_all(comment="FORCED EXIT TIME")
        tradeDone   := true
        waitingBuy  := false
        waitingSell := false
        orderPlaced := false

    // Cancel any pending orders too (safe)
    strategy.cancel("BUY-LIMIT")
    strategy.cancel("SELL-LIMIT")

// If a trade opens OR a trade closes, mark done for the day
if (opentrades_chg > 0) or (closedtrades_chg > 0)
    tradeDone   := true
    waitingBuy  := false
    waitingSell := false
    orderPlaced := false
    strategy.cancel("BUY-LIMIT")
    strategy.cancel("SELL-LIMIT")

// If entry window ends, cancel any pending order and stop for the day
if not inEntryTime
    waitingBuy  := false
    waitingSell := false
    orderPlaced := false
    strategy.cancel("BUY-LIMIT")
    strategy.cancel("SELL-LIMIT")

//==================== 1) BREAKOUT CONFIRMATION (5m CLOSE) ====================
canDetectBreakout = isGold and is5m and levelsReady and inEntryTime and not dayLocked and not tradeDone and strategy.position_size == 0

if canDetectBreakout
    if close > level62_5
        dayLocked   := true
        waitingBuy  := true
        waitingSell := false
        orderPlaced := false
        strategy.cancel("SELL-LIMIT")
    else if close < level37_5
        dayLocked   := true
        waitingSell := true
        waitingBuy  := false
        orderPlaced := false
        strategy.cancel("BUY-LIMIT")

//==================== 2) PLACE LIMIT ONLY ONCE ====================
canPlace = isGold and is5m and levelsReady and inEntryTime and dayLocked and not tradeDone and strategy.position_size == 0

if canPlace and waitingBuy and not orderPlaced
    strategy.entry("BUY-LIMIT", strategy.long, limit=level62_5)
    strategy.exit("BUY-EXIT", "BUY-LIMIT", stop=buySL, limit=buyTP)
    orderPlaced := true

if canPlace and waitingSell and not orderPlaced
    strategy.entry("SELL-LIMIT", strategy.short, limit=level37_5)
    strategy.exit("SELL-EXIT", "SELL-LIMIT", stop=sellSL, limit=sellTP)
    orderPlaced := true

//==================== VISUAL ====================
plot(level62_5, "Level 62.5%", color=color.new(color.green, 0))
plot(level37_5, "Level 37.5%", color=color.new(color.red, 0))

plot(anchorOpen, "Anchor Open (6:00/7:00)", color=color.new(color.yellow, 0))

plot(rangUp,   "Range Up (rangUp)", color=color.new(color.blue, 0))
plot(rangDown, "Range Down (rangDown)", color=color.new(color.orange, 0))

plot(extUpMid, "Ext Up Mid (Base)", color=color.new(color.purple, 0))
plot(extUpTop, "Ext Up Top (Full)", color=color.new(color.purple, 40))
plot(extDownMid, "Ext Down Mid (Base)", color=color.new(color.teal, 0))
plot(extDownBot, "Ext Down Bot (Full)", color=color.new(color.teal, 40))