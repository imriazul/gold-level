//@version=5
indicator("Gold label indicator by @imriazul", overlay=true)

//==================== SETTINGS ====================
useDST        = input.bool(true, "DST", tooltip="Daylight Saving Time ON/OFF")
showBoxSystem = input.bool(true, "Show Box System")
keepBoxes     = input.int(7, "Keep last N days boxes", minval=1, maxval=300)
sqrtOffset    = input.float(0.105, "GRSN Value", step=0.001, minval=0.0, tooltip="For best Result, Ask strategy builder")

boxBorderCol  = input.color(color.rgb(0, 128, 255), "Box Border Color")
boxFillCol    = input.color(color.new(#ff9900, 100), "Box Fill Color")
midCol        = input.color(color.rgb(0, 128, 255), "Mid Line Color")
col37         = input.color(color.new(#ff042a, 5), "37.5% Line Color")
col62         = input.color(color.new(#0d821a, 8), "62.5% Line Color")

//==================== TIME & SYMBOL CHECKS ====================
dhakaHour   = hour(time, "Asia/Dhaka")
dhakaMinute = minute(time, "Asia/Dhaka")

targetHour   = useDST ? 6 : 7
isTargetTime = (dhakaHour == targetHour and dhakaMinute == 0)

isGoldChart = syminfo.ticker == "XAUUSD" or syminfo.ticker == "GOLD" or str.contains(syminfo.ticker, "XAU")
is5m        = (timeframe.period == "5")

//==================== EMAs ====================
ema9   = ta.ema(close, 9)
ema15  = ta.ema(close, 15)
ema50  = ta.ema(close, 50)
ema100 = ta.ema(close, 100)
ema200 = ta.ema(close, 200)

plot(ema9,   "EMA 9",   color=color.blue,   linewidth=1)
plot(ema15,  "EMA 15",  color=color.blue,   linewidth=1)
plot(ema50,  "EMA 50",  color=color.orange, linewidth=1)
plot(ema100, "EMA 100", color=color.green,  linewidth=1)
plot(ema200, "EMA 200", color=color.red,    linewidth=1)

//==================== RANGE + LEVEL VARS ====================
var float openingValue = na
var float rangUp       = na
var float rangDown     = na
var float level37_5    = na
var float level62_5    = na

// Keep ONLY mid extensions (per your request)
var float extUpMid     = na
var float extDownMid   = na

// NEW HIGH / NEW LOW
var float newHigh      = na
var float newLow       = na

//==================== BOX OBJECT STORAGE (KEEP HISTORY) ====================
var box[]  boxes = array.new_box()
var line[] mids  = array.new_line()
var line[] l37s  = array.new_line()
var line[] l62s  = array.new_line()

f_trimHistory() =>
    while array.size(boxes) > keepBoxes
        box.delete(array.shift(boxes))
    while array.size(mids) > keepBoxes
        line.delete(array.shift(mids))
    while array.size(l37s) > keepBoxes
        line.delete(array.shift(l37s))
    while array.size(l62s) > keepBoxes
        line.delete(array.shift(l62s))

f_endTs_8am_dhaka(_t) =>
    y = year(_t, "Asia/Dhaka")
    m = month(_t, "Asia/Dhaka")
    d = dayofmonth(_t, "Asia/Dhaka")
    timestamp("Asia/Dhaka", y, m, d, 8, 0)

//==================== BUILD RANGE ON TARGET CANDLE ====================
if isGoldChart and isTargetTime and (timeframe.period == "3" or timeframe.period == "5" or timeframe.period == "15" or timeframe.period == "30")
    openingValue := open

    sqrtVal  = math.sqrt(openingValue)
    forUp    = sqrtVal + sqrtOffset
    forDown  = sqrtVal - sqrtOffset
    rangUp   := forUp * forUp
    rangDown := forDown * forDown

    rangeDiff = rangUp - rangDown
    level37_5 := rangDown + rangeDiff * 0.375
    level62_5 := rangDown + rangeDiff * 0.625

    innerH = level62_5 - level37_5
    extH   = innerH * 2.0

    // Keep ONLY these two (unchanged logic)
    extUpMid   := rangUp + (extH / 2.0)
    extDownMid := rangDown - (extH / 2.0)

    //==================== NEW HIGH / NEW LOW (Requested) ====================
    newHighDist = rangUp - level37_5
    newHigh     := rangUp + newHighDist

    newLowDist  = level62_5 - rangDown
    newLow      := rangDown - newLowDist

    if showBoxSystem
        endTs    = f_endTs_8am_dhaka(time)
        midPrice = (rangUp + rangDown) / 2.0

        b   = box.new(time, rangUp, endTs, rangDown, xloc=xloc.bar_time, border_color=boxBorderCol, bgcolor=boxFillCol)
        lm  = line.new(time, midPrice, endTs, midPrice, xloc=xloc.bar_time, color=midCol, width=1)
        l37 = line.new(time, level37_5, endTs, level37_5, xloc=xloc.bar_time, color=col37, width=1)
        l62 = line.new(time, level62_5, endTs, level62_5, xloc=xloc.bar_time, color=col62, width=1)

        array.push(boxes, b)
        array.push(mids, lm)
        array.push(l37s, l37)
        array.push(l62s, l62)
        f_trimHistory()

//==================== PLOT LEVELS ====================
plot(level37_5, "Level 37.5%", color=color.new(#f805ec, 0), linewidth=1, style=plot.style_linebr)
plot(level62_5, "Level 62.5%", color=color.new(#f805ec, 0), linewidth=1, style=plot.style_linebr)

// Keep ONLY mid extensions plots
plot(extUpMid,   "Ext Up Mid (Base TP)",   color=color.new(color.gray, 10), linewidth=1, style=plot.style_linebr)
plot(extDownMid, "Ext Down Mid (Base TP)", color=color.new(color.gray, 20), linewidth=1, style=plot.style_linebr)

// NEW HIGH / NEW LOW plots
plot(newHigh, "New High", color=color.new(color.gray, 10), linewidth=1, style=plot.style_linebr)
plot(newLow,  "New Low",  color=color.new(color.gray, 10), linewidth=1, style=plot.style_linebr)